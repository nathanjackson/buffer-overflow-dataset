# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y dnf-plugins-core
RUN dnf config-manager --enable crb
RUN dnf builddep -y tpm2-tss
RUN dnf install -y git libasan libuuid-devel

ARG SOURCE_TREE
ARG SOURCE_LABELS
ARG CONFIGURE_ARGS
ARG EXTRA_CFLAGS
ARG EXTRA_CXXFLAGS
ADD $SOURCE_TREE /tpm2-tss-src
WORKDIR /tpm2-tss-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV CXXFLAGS=$EXTRA_CXXFLAGS
RUN ./configure --prefix=/tpm2-tss \
        $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo) && \
    make install
WORKDIR /

ARG REPRO_CC_ARGS
ADD repro.c /repro.c
RUN gcc $REPRO_CC_ARGS \
        -c -Itpm2-tss/include repro.c && \
    gcc $REPRO_CC_ARGS \
        repro.o -Ltpm2-tss/lib -ltss2-rc -o repro

ADD src2bin_labels.py /
ADD $SOURCE_LABELS /
RUN python3 -m venv /env && \
    . ./env/bin/activate && \
    python3 -m pip install pyelftools && \
    python3 /src2bin_labels.py /tpm2-tss/lib/libtss2-rc.so.0.0.0 /src_labels.csv

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /tpm2-tss /tpm2-tss
COPY --from=builder /repro /repro
COPY --from=builder /bin_labels.csv /

ENV DATASET_BINARY=/tpm2-tss/lib/libtss2-rc.so.0.0.0

CMD LD_LIBRARY_PATH=/tpm2-tss/lib ASAN_OPTIONS=halt_on_error=0 ./repro
