# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y dnf-plugins-core
RUN dnf config-manager --enable crb
RUN dnf builddep -y tpm2-tss
RUN dnf install -y git libasan libuuid-devel

ARG SOURCE_TREE
ARG CONFIGURE_ARGS
ARG EXTRA_CFLAGS
ARG EXTRA_CXXFLAGS
ADD $SOURCE_TREE /tpm2-tss-src
WORKDIR /tpm2-tss-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV CXXFLAGS=$EXTRA_CXXFLAGS
RUN ./configure --prefix=/tpm2-tss --enable-debug \
        $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo) && \
    make install
WORKDIR /

ARG REPRO_CC_ARGS
ADD repro.c /repro.c
RUN gcc $REPRO_CC_ARGS \
        -c -Itpm2-tss/include repro.c && \
    gcc $REPRO_CC_ARGS \
        repro.o -Ltpm2-tss/lib -ltss2-rc -o repro

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /tpm2-tss /tpm2-tss
COPY --from=builder /repro /repro

CMD LD_LIBRARY_PATH=/tpm2-tss/lib ASAN_OPTIONS=halt_on_error=0 ./repro
