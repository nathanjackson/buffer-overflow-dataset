# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y dnf-plugins-core
RUN dnf config-manager --enable crb
RUN dnf builddep -y tpm2-tss
RUN dnf install -y git libasan libuuid-devel

ARG SOURCE_TREE
ADD $SOURCE_TREE /tpm2-tss-src
WORKDIR /tpm2-tss-src

RUN CFLAGS='-fsanitize-recover=address' \
    CXXFLAGS='-fsanitize-recover=address' \
    ./configure --prefix=/tpm2-tss --enable-debug \
        --with-sanitizer=address && \
    make -j$(grep -c ^proc /proc/cpuinfo) && \
    make install
WORKDIR /

ADD repro.c /repro.c
RUN gcc -fsanitize=address -fsanitize-recover=address \
        -c -Itpm2-tss/include repro.c && \
    gcc -fsanitize=address -fsanitize-recover=address \
        repro.o -Ltpm2-tss/lib -ltss2-rc -o repro

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /tpm2-tss /tpm2-tss
COPY --from=builder /repro /repro

CMD LD_LIBRARY_PATH=/tpm2-tss/lib ASAN_OPTIONS=halt_on_error=0 ./repro
