#!/bin/bash

POSITIONAL_ARGS=()

ENABLE_ASAN=0

while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--asan)
            ENABLE_ASAN=1
            shift
            ;;
        -d|--debug)
            ENABLE_DEBUG=1
            shift
            ;;
        -o|--optimization)
            OPTIMIZATION_LEVEL="$2"
            shift
            shift
            ;;
        -h|--help)
            echo usage: $0 [-a] [-d] [-h] [-o LEVEL] variant
            exit 1
            ;;
        *)
            POSITIONAL_ARGS+=("$1")
            shift
            ;;
    esac
done

set -- "${POSITIONAL_ARGS[@]}"

case $1 in
    patched)
        SOURCE_TREE=patched/tpm2-tss
        SOURCE_LABELS=patched/src_labels.csv
        ;;
    vulnerable)
        SOURCE_TREE=vulnerable/tpm2-tss
        SOURCE_LABELS=vulnerable/src_labels.csv
        ;;
    *)
        echo \'patched\' or \'vulnerable\' must be specified.
        exit 1
        ;;
esac

CONFIGURE_ARGS=''
DOCKER_TAG="$1"

echo version = $1
if [[ "$ENABLE_ASAN" -eq 1 ]];
then
    echo asan = yes
    CONFIGURE_ARGS+=' --with-sanitizer=address'
    EXTRA_CFLAGS='-fsanitize-recover=address'
    EXTRA_CXXFLAGS='-fsanitize-recover=address'
    REPRO_CC_ARGS='-fsanitize=address -fsanitize-recover=address'
    DOCKER_TAG+="-asan"
else
    echo asan = no
fi

if [[ "$ENABLE_DEBUG" -eq 1 ]];
then
    echo debug = yes
    CONFIGURE_ARGS+=' --enable-debug'
    DOCKER_TAG+="-debug"
else
    echo debug = no
fi

if [[ ! "$OPTIMIZATION_LEVEL" ]];
then
    OPTIMIZATION_LEVEL="0"
fi

echo optimization level = "$OPTIMIZATION_LEVEL"
EXTRA_CFLAGS+=" -O$OPTIMIZATION_LEVEL"
EXTRA_LDFLAGS+=" -O$OPTIMIZATION_LEVEL"
DOCKER_TAG+="-O$OPTIMIZATION_LEVEL"

cp ../src2bin_labels.py .

docker build -t buffer-overflow-dataset/cve-2023-22745:$DOCKER_TAG \
    --build-arg SOURCE_TREE="$SOURCE_TREE" \
    --build-arg SOURCE_LABELS="$SOURCE_LABELS" \
    --build-arg CONFIGURE_ARGS="$CONFIGURE_ARGS" \
    --build-arg EXTRA_CFLAGS="$EXTRA_CFLAGS" \
    --build-arg EXTRA_CXXFLAGS="$EXTRA_CXXFLAGS" \
    --build-arg REPRO_CC_ARGS="$REPRO_CC_ARGS" .

rm src2bin_labels.py
