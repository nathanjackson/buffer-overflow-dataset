# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y gcc make libasan ncurses-devel libtool autoconf wget gcc-c++ gdb

ARG SOURCE_TREE
ARG SOURCE_LABELS
ARG EXTRA_CFLAGS
ARG EXTRA_LDFLAGS
ARG CONFIGURE_ARGS
ADD $SOURCE_TREE /libtiff-src
WORKDIR /libtiff-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV LDFLAGS=$EXTRA_LDFLAGS
RUN ./autogen.sh && \
    ./configure --prefix=/libtiff-install $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo) && \
    make install
WORKDIR /

ADD src2bin_labels.py /
ADD $SOURCE_LABELS /

RUN python3 -m venv /env && \
    . ./env/bin/activate && \
    python3 -m pip install pyelftools && \
    python3 /src2bin_labels.py /libtiff-install/bin/tiffcp /src_labels.csv

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /libtiff-install /libtiff-install
COPY --from=builder /bin_labels.csv /

ENV DATASET_BINARY=/libtiff-install/bin/tiffcp

CMD /libtiff-install/bin/tiffcp -8 -8 -8 -8 -8 -8 -8 -8 -8 -8 ./i ./i
