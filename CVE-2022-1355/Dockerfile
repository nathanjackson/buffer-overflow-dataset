# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y gcc make libasan ncurses-devel libtool autoconf wget gcc-c++

ARG SOURCE_TREE
ARG EXTRA_CFLAGS
ARG EXTRA_LDFLAGS
ARG CONFIGURE_ARGS
ADD $SOURCE_TREE /libtiff-src
WORKDIR /libtiff-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV LDFLAGS=$EXTRA_LDFLAGS
RUN ./autogen.sh && \
    ./configure --prefix=/libtiff-install $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo) && \
    make install
WORKDIR /

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /libtiff-install /libtiff-install

CMD /libtiff-install/bin/tiffcp -8 -8 -8 -8 -8 -8 -8 -8 -8 -8 ./i ./i
