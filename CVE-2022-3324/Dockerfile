# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y gcc make libasan ncurses-devel

ARG SOURCE_TREE
ARG SOURCE_LABELS
ARG EXTRA_CFLAGS
ARG EXTRA_LDFLAGS
ARG CONFIGURE_ARGS
ADD $SOURCE_TREE /vim-src
WORKDIR /vim-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV LDFLAGS=$EXTRA_LDFLAGS
RUN ./configure $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo)
WORKDIR /

ADD src2bin_labels.py /
ADD $SOURCE_LABELS /

RUN python3 -m venv /env && \
    . ./env/bin/activate && \
    python3 -m pip install pyelftools && \
    python3 /src2bin_labels.py /vim-src/src/vim /src_labels.csv

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /vim-src/src/vim /usr/local/bin/
COPY --from=builder /bin_labels.csv /

ADD poc1_stack.dat /poc1_stack.dat

ENV DATASET_BINARY=/usr/local/bin/vim

CMD /usr/local/bin/vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc1_stack.dat -c :qa!
