# Build Stage
FROM rockylinux:9 as builder

RUN dnf install -y gcc make libasan ncurses-devel

#RUN dnf install -y dnf-plugins-core
#RUN dnf config-manager --enable crb
#RUN dnf builddep -y tpm2-tss
#RUN dnf install -y git libasan libuuid-devel

ARG SOURCE_TREE
ARG EXTRA_CFLAGS
ARG EXTRA_LDFLAGS
ARG CONFIGURE_ARGS
ADD $SOURCE_TREE /vim-src
WORKDIR /vim-src

ENV CFLAGS=$EXTRA_CFLAGS
ENV LDFLAGS=$EXTRA_LDFLAGS
RUN ./configure $CONFIGURE_ARGS && \
    make -j$(grep -c ^proc /proc/cpuinfo)
WORKDIR /

# Package Stage
FROM rockylinux:9

RUN dnf install -y libasan && dnf clean all
COPY --from=builder /vim-src/src/vim /usr/local/bin/

ADD poc1_stack.dat /poc1_stack.dat

CMD /usr/local/bin/vim -u NONE -i NONE -n -m -X -Z -e -s -S /poc1_stack.dat -c :qa!
