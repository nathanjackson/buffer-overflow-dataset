# Build Stage
FROM rockylinux:9-minimal as builder

RUN microdnf install -y cmake gcc-c++ make libasan

ARG SOURCE_TREE
ARG CMAKE_BUILD_TYPE
ARG CMAKE_C_FLAGS
ARG CMAKE_CXX_FLAGS
ADD $SOURCE_TREE /upx
WORKDIR /upx
RUN mkdir build && \
    cd build && \
    cmake -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
          -DCMAKE_C_FLAGS=$CMAKE_C_FLAGS \
          -DCMAKE_CXX_FLAGS=$CMAKE_CXX_FLAGS .. && \
    make -j$(grep -c ^proc /proc/cpuinfo)

# Package Stage
FROM rockylinux:9-minimal
RUN microdnf install -y libasan && microdnf clean all
COPY --from=builder /upx/build/upx /usr/local/bin/
ADD POC1 /POC1
CMD upx /POC1
