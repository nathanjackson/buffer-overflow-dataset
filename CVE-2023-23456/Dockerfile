# Build Stage
FROM rockylinux:9-minimal as builder

RUN microdnf install -y cmake gcc-c++ make libasan

ARG SOURCE_TREE
ARG CMAKE_C_FLAGS
ARG CMAKE_C_FLAGS_CUSTOM
ARG CMAKE_CXX_FLAGS
ARG CMAKE_CXX_FLAGS_CUSTOM
ADD $SOURCE_TREE /upx
WORKDIR /upx
RUN mkdir build && \
    cd build && \
    cmake -DCMAKE_BUILD_TYPE=Custom \
          -DCMAKE_C_FLAGS="$CMAKE_C_FLAGS" \
          -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" \
          -DCMAKE_C_FLAGS_CUSTOM="$CMAKE_C_FLAGS_CUSTOM" \
          -DCMAKE_CXX_FLAGS_CUSTOM="$CMAKE_CXX_FLAGS_CUSTOM" .. && \
          make -j$(grep -c ^proc /proc/cpuinfo)

# Package Stage
FROM rockylinux:9-minimal
RUN microdnf install -y libasan && microdnf clean all
COPY --from=builder /upx/build/upx /usr/local/bin/
ENV DATASET_BINARY=/usr/local/bin/upx
ADD POC1 /POC1
CMD upx /POC1
