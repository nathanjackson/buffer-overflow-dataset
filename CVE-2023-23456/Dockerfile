# Build Stage
FROM rockylinux:9-minimal as builder

RUN microdnf install -y cmake gcc-c++ make libasan

ADD upx /upx
WORKDIR /upx
RUN mkdir build && \
    cd build && \
    cmake -DCMAKE_C_FLAGS='-fsanitize=address' \
          -DCMAKE_CXX_FLAGS='-fsanitize=address' .. && \
    make -j$(grep -c ^proc /proc/cpuinfo)

# Package Stage
FROM rockylinux:9-minimal
RUN microdnf install -y libasan && microdnf clean all
COPY --from=builder /upx/build/upx /usr/local/bin/
ADD POC1 /POC1
CMD upx /POC1
